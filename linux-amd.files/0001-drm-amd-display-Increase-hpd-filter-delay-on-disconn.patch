From e4dcdd4fe2f89dbd3455793a19885efd464fc8e9 Mon Sep 17 00:00:00 2001
From: Carl Kittelberger <icedream@icedream.pw>
Date: Mon, 7 Aug 2023 03:54:09 +0200
Subject: [PATCH] drm/amd/display: Increase hpd filter delay on disconnect.

---
 drivers/gpu/drm/amd/display/dc/link/link_dpms.c          | 6 ++++--
 drivers/gpu/drm/amd/display/dc/link/link_factory.c       | 3 ++-
 drivers/gpu/drm/amd/display/dc/link/protocols/link_hpd.c | 2 +-
 3 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/amd/display/dc/link/link_dpms.c b/drivers/gpu/drm/amd/display/dc/link/link_dpms.c
index 2267fb097830..a762bd555260 100644
--- a/drivers/gpu/drm/amd/display/dc/link/link_dpms.c
+++ b/drivers/gpu/drm/amd/display/dc/link/link_dpms.c
@@ -172,8 +172,10 @@ void link_set_all_streams_dpms_off_for_link(struct dc_link *link)
 
 void link_resume(struct dc_link *link)
 {
-	if (link->connector_signal != SIGNAL_TYPE_VIRTUAL)
-		program_hpd_filter(link);
+	if (link->connector_signal != SIGNAL_TYPE_VIRTUAL) {
+		dc_link_enable_hpd_filter(link, true);
+		//program_hpd_filter(link);
+	}
 }
 
 /* This function returns true if the pipe is used to feed video signal directly
diff --git a/drivers/gpu/drm/amd/display/dc/link/link_factory.c b/drivers/gpu/drm/amd/display/dc/link/link_factory.c
index 1515c817f03b..54479eaafb3b 100644
--- a/drivers/gpu/drm/amd/display/dc/link/link_factory.c
+++ b/drivers/gpu/drm/amd/display/dc/link/link_factory.c
@@ -707,7 +707,8 @@ static bool construct_phy(struct dc_link *link,
 	 * If GPIO isn't programmed correctly HPD might not rise or drain
 	 * fast enough, leading to bounces.
 	 */
-	program_hpd_filter(link);
+	dc_link_enable_hpd_filter(link, true);
+	//program_hpd_filter(link);
 
 	link->psr_settings.psr_vtotal_control_support = false;
 	link->psr_settings.psr_version = DC_PSR_VERSION_UNSUPPORTED;
diff --git a/drivers/gpu/drm/amd/display/dc/link/protocols/link_hpd.c b/drivers/gpu/drm/amd/display/dc/link/protocols/link_hpd.c
index e3d729ab5b9f..278fc76139a3 100644
--- a/drivers/gpu/drm/amd/display/dc/link/protocols/link_hpd.c
+++ b/drivers/gpu/drm/amd/display/dc/link/protocols/link_hpd.c
@@ -189,7 +189,7 @@ bool program_hpd_filter(const struct dc_link *link)
 	case SIGNAL_TYPE_HDMI_TYPE_A:
 		/* Program hpd filter */
 		delay_on_connect_in_ms = 500;
-		delay_on_disconnect_in_ms = 100;
+		delay_on_disconnect_in_ms = 1200;
 		break;
 	case SIGNAL_TYPE_DISPLAY_PORT:
 	case SIGNAL_TYPE_DISPLAY_PORT_MST:
-- 
2.41.0

